<html>

<head>
  <link rel="stylesheet" href="css/user-gesture.css">

  <!-- Imports -->
  <script src="/js/aframe.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
</head>

<script>
  const socket = io({transports: ['websocket'], upgrade: false});

  // emitted when this player connects
  socket.on('connect', () => {
  });

  // emitted to update the position of all other players
  socket.on('updatePlayers', (data) => {
    // get the players-controller
    var playersController = document.querySelector('[players-controller]');

    // loop through each player in the data list
    for (var i = 0; i < data.players.length; i++) {
      // update the current player from the list
      playersController.emit('updatePlayer', {player: data.players[i]});
    }
  });

  // emitted at the beginning to get all currently connected players
  socket.on('spawnInitialPlayers', (data) => {
    // get the players-controller
    var playersController = document.querySelector('[players-controller]');

    // loop through each player in the data list
    for (var i = 0; i < data.players.length; i++) {
      // make sure the current player is not ourself
      if (data.players[i].id != socket.id) {
        // add the connected player from the list
        playersController.emit('addPlayer', {player: data.players[i]});
      }
    }
  });

  // emitted to add a new player on the client side
  socket.on('playerJoined', (data) => {
    document.querySelector('[players-controller]').emit(
      'addPlayer', {player: data.player});
  });

  // emitted to remove a player on the client side
  socket.on('playerQuit', (data) => {
    document.querySelector('[players-controller]').emit(
      'removePlayer', {playerId: data.playerId});
  });

  // Creates a random hex color
  const randomColor = () => {
    return('#' + Math.floor(Math.random() * 16777215).toString(16));
  }

  // allows for easily getting position as a THREE vector3
  const getPosition = (element) => {
    return element.object3D.getWorldPosition(new THREE.Vector3())
      .clone();
  }

  // allows for easily getting a rotation as a THREE quat
  const getRotation = (element) => {
    return element.object3D.getWorldQuaternion(new THREE.Quaternion())
      .clone();
  }




  AFRAME.registerComponent('player', {
    schema: {
      moveThreshold: {type:'number', default: 0.1},
      rotationThreshold: {type: 'number', default: 0.1}
    },
    init: function() {
      // set up initial vars
      this.lastPosition = getPosition(this.el);
      this.lastRotation = getRotation(this.el);
    },

    tick: function() {
      var newPosition = getPosition(this.el);
      var newRotation = getRotation(this.el);

      // check if the player has moved more than the threshold amount
      if (this.hasMoved(newPosition) || this.hasRotated(newRotation)) {
        // emit a moved event to the server with the new position
        socket.emit('moved', {
          newPosition:
          {x: newPosition.x, y: newPosition.y, z: newPosition.z},
          newRotation:
          {x: newRotation.x, y: newRotation.y, z: newRotation.z,
            w: newRotation.w}});
      }
    },

    hasMoved: function(newPosition) {
      // check if the player has moved more than the threshold
      if (this.lastPosition.distanceTo(newPosition) >
        this.data.moveThreshold)
      {
        // console.log('Moved!');
        this.lastPosition = newPosition;
        return true;
      } else {
        return false;
      }
    },

    hasRotated: function(newRotation) {
      // check if the player has rotated more than the threshold
      if (Math.abs(
        THREE.MathUtils.radToDeg(this.lastRotation.angleTo(newRotation))) >
        this.data.rotationThreshold)
      {
        // console.log('Rotated!');
        this.lastRotation = newRotation;
        return true;
      } else {
        return false;
      }
    }
  });

  // The PlayerController component (creates, removes, and updates other
  // players who have joined)
  AFRAME.registerComponent('players-controller', {
    init: function () {
      var el = this.el;

      el.addEventListener('updatePlayer', function (data) {
        // get each spawned player
        var spawnedPlayers = document.querySelectorAll('[other-player]');

        // loop through each spawned player
        for (var i = 0; i < spawnedPlayers.length; i++) {
          // check if the current spawned player should be updated (by id)
          if (spawnedPlayers[i].getAttribute('id') ==
            data.detail.player.id)
          {
            // update the position of the player
            spawnedPlayers[i].setAttribute('position',
              data.detail.player.position);

            // update the rotatino of the player
            spawnedPlayers[i].object3D.quaternion.set(
              data.detail.player.rotation.x,
              data.detail.player.rotation.y,
              data.detail.player.rotation.z,
              data.detail.player.rotation.w
            )

            // update the other-player data of the player
            spawnedPlayers[i].setAttribute('other-player', {
              name: data.detail.player.name
            });
          }
        }
      });

      el.addEventListener('addPlayer', function (data) {
        // create a new entity element
        playerEl = document.createElement('a-entity');

        // setup the attributes of the new player element
        playerEl.setAttribute('other-player', {
          name: data.detail.player.name
        });
        playerEl.setAttribute('id', data.detail.player.id);
        playerEl.setAttribute('position', data.detail.player.position);

        playerEl.object3D.quaternion.set(
          data.detail.player.rotation.x,
          data.detail.player.rotation.y,
          data.detail.player.rotation.z,
          data.detail.player.rotation.w
        )

        console.log('Player ' + playerEl.getAttribute('id') + ' added.');

        // append the new player element to the players-controller element
        el.appendChild(playerEl);
      });

      el.addEventListener('removePlayer', function (data) {
        // get each spawned player
        var spawnedPlayers = document.querySelectorAll('[other-player]');

        // loop through each spawned player
        for (let i = 0; i < spawnedPlayers.length; i++) {
          // check if the current spawned player should be removed (by id)
          if (spawnedPlayers[i].getAttribute('id') ==
            data.detail.playerId)
          {
            console.log('Player ' + spawnedPlayers[i].getAttribute('id')
              + ' removed.');

            // remove the spawned player
            spawnedPlayers[i].parentNode.removeChild(spawnedPlayers[i]);
          }
        }
      });
    }
  });

  // the OtherPlayer component (created to visualize other connected players)
  AFRAME.registerComponent('other-player', {
    schema: {
      name: {type: 'string', default: ''},
      color: {type: 'color', default: 'grey'}
    },
    init: function () {
      this.el.setAttribute('geometry', {
        primitive: 'box',
        height: 1.6,
        depth: 0.5
      });
      this.el.setAttribute('material', {
        color: this.data.color
      });
    }
  });

  AFRAME.registerComponent('hmd', {
  init: function ()
  {
    const hmdComp = this;
    let inView = false;

    this.el.addEventListener('click', function()
    {
      if(inView == false)
      {
        inView = true;

        // let overlay = document.querySelector('#ui');
        // overlay.setAttribute('style', 'visibility: hidden');

        let camera = document.querySelector('#camera');
        camera.removeAttribute('wasd-controls');
        camera.removeAttribute('look-controls');

        let camPos = camera.getAttribute('position');
        let xCam = camPos.x;
        let yCam = camPos.y;
        let zCam = camPos.z;

        let camRot = camera.getAttribute('rotation');
        let xCamRot = camRot.x;
        let yCamRot = camRot.y;
        let zCamRot = camRot.z;

        let objectPos = this.getAttribute('position');
        let xObject = objectPos.x;
        let yObject = objectPos.y;
        let zObject = objectPos.z;

        // camera.setAttribute('animation', 'property: position; from: 0 2 0; to: 0 2 -2; loop: false; dur:1000;')
        camera.setAttribute('animation', 'property:position; from: ' + xCam.toString() + ' ' + yCam.toString() + ' ' + zCam.toString() + '; to: ' + xObject.toString() + ' ' + (yObject + 1.5).toString() + ' ' + (zObject+1).toString() +'; loop:false; dur:1500; easing: linear;')
        camera.setAttribute('animation__2', 'property:rotation; from: ' + xCamRot.toString() + ' ' + yCamRot.toString() + ' ' + zCamRot.toString() + '; to: 0 0 0; loop :false; dur:1500; easing: linear;')

        hmdComp.el.setAttribute('animation', 'property:position; from: ' + xObject.toString() + ' ' + yObject.toString() + ' ' + zObject.toString() + '; to: ' + xObject.toString() + ' ' + (yObject + 1.5).toString() + ' ' + (zObject).toString() +'; loop:false; dur:1500; easing: linear;')

        setTimeout(function()
        {
          let text = document.querySelector('#text');
          text.setAttribute('style', 'visibility: visible');
        }, 1500);
      }

      else
      {
        inView = false;

        let text = document.querySelector('#text');
        text.setAttribute('style', 'visibility: hidden');

        // let overlay = document.querySelector('#ui');
        // overlay.setAttribute('style', 'visibility: visible');

        let camera = document.querySelector('#camera');

        setTimeout(function()
        {
        camera.setAttribute('wasd-controls', '');
        camera.setAttribute('look-controls', '');
        }, 1500);

        let camPos = camera.getAttribute('position');
        let xCam = camPos.x;
        let yCam = camPos.y;
        let zCam = camPos.z;

        let objectPos = this.getAttribute('position');
        let xObject = objectPos.x;
        let yObject = objectPos.y;
        let zObject = objectPos.z;

        camera.setAttribute('animation', 'property:position; from: ' + xCam.toString() + ' ' + yCam.toString() + ' ' + zCam.toString() + '; to: ' + xObject.toString() + ' 2 ' + (zObject+3).toString() +'; loop:false; dur:1500; easing: linear;')

        hmdComp.el.setAttribute('animation', 'property:position; from: ' + xObject.toString() + ' ' + yObject.toString() + ' ' + zObject.toString() + '; to: ' + xObject.toString() + ' ' + (yObject - 1.5).toString() + ' ' + (zObject).toString() +'; loop:false; dur:1500; easing: linear;')
      }
    });
  }
});
</script>

<body>
  <a-scene>
    <!-- <div id="ui"></div> -->
    <div id="text"></div>

      <a-assets timeout="10000">
        <a-asset-item id="hmd-gltf" src="assets/scene.gltf"></a-asset-item>
      </a-assets>

    <!-- LIGHTS -->
    <a-entity id='lights'>
      <a-entity light="type:point; intensity:1.0; castShadow:false;"
                position="0 5 5"
                rotation="-45 0 0">
      </a-entity>

      <a-entity light="type:spot; intensity:1.0; castShadow:true; angle:25"
                position="0 5 -4"
                rotation="-90 0 0">
      </a-entity>
    </a-entity>

    <a-entity id="camera" player camera wasd-controls look-controls position="0 2 0">
      <a-entity class='geo'></a-entity>
      <a-entity cursor="rayOrigin:mouse;" raycaster="far:20; interval:200; objects: .interactive"></a-entity>
    </a-entity>

    <!-- PLAYERS CONTROLLER (for viewing other players) -->
    <a-entity players-controller></a-entity>

    <a-entity hmd
              gltf-model="#hmd-gltf"
              class="interactive"
              position="0 1.65 -3.9"
              scale="0.06 0.06 0.06"
              rotation="0 25 0"
              shadow="cast: true; receive: true">
    </a-entity>

    <!-- PEDESTAL -->
    <a-entity id='pedestal'>
      <a-entity id="floor" position="0 0 -2.5" rotation="-90 0 0" scale="1 1 1"
                geometry="primitive:plane; width:15; height:20;" material="color:#CCCCCC"
                shadow="cast: true; receive: true">
      </a-entity>

      <a-entity id="ceiling" position="0 7.5 -2.5" rotation="90 0 0" scale="1 1 1"
                geometry="primitive:plane; width:15; height:20;" material="color:#303030"
                shadow="cast: true; receive: true">
      </a-entity>

      <a-entity id="pedestalPillar" position="0 0.5 -4" rotation="0 0 0" scale="1 1 1"
                geometry="primitive:cylinder; height:2; radius: 0.5;" material="color:red"
                shadow="cast: true; receive: true">
      </a-entity>

      <a-dodecahedron position="0 -1.4 -4"
        rotation="-32.5 1.5 0"
        material="color:black"
        radius="2"
        shadow="cast:true; receive:true;">
      </a-dodecahedron>
    </a-entity>

    <!-- WALL A -->
    <a-entity id='wall-a'>
      <a-entity id="WallA1" position="7.5 3.5 -6.5" rotation="0 0 0" scale="1 1 1"
                geometry="primitive:box; width:0.5; height:8; depth:12;" material="color:#505050"
                shadow="cast: true; receive: true">
      </a-entity>

      <a-entity id="WallA2" position="7.5 3.5 5" rotation="0 0 0" scale="1 1 1"
                geometry="primitive:box; width:0.5; height:8; depth:5;" material="color:#505050"
                shadow="cast: true; receive: true">
      </a-entity>

      <a-entity id="WallA3" position="7.5 5.75 1" rotation="0 0 0" scale="1 1 1"
                geometry="primitive:box; width:0.5; height:3.5; depth:3;" material="color:#505050"
                shadow="cast: true; receive: true">
      </a-entity>

      <a-entity id="TrimA1" position="7 0 -6.5" rotation="0 0 0" scale="1 1 1"
                geometry="primitive:box; width:0.5; height:0.5; depth:12;" material="color:black"
                shadow="cast: true; receive: true">
      </a-entity>

      <a-entity id="TrimA2" position="7 0 5" rotation="0 0 0" scale="1 1 1"
                geometry="primitive:box; width:0.5; height:0.5; depth:5;" material="color:black"
                shadow="cast: true; receive: true">
      </a-entity>
    </a-entity>

    <!-- WALL B -->
    <a-entity id='wall-b'>
      <a-entity id="WallB1" position="-7.5 3.5 -6.5" rotation="0 0 0" scale="1 1 1"
                geometry="primitive:box; width:0.5; height:8; depth:12;" material="color:#505050"
                shadow="cast: true; receive: true">
      </a-entity>

      <a-entity id="WallB2" position="-7.5 3.5 5" rotation="0 0 0" scale="1 1 1"
                geometry="primitive:box; width:0.5; height:8; depth:5;" material="color:#505050"
                shadow="cast: true; receive: true">
      </a-entity>

      <a-entity id="WallB3" position="-7.5 5.75 1" rotation="0 0 0" scale="1 1 1"
                geometry="primitive:box; width:0.5; height:3.5; depth:3;" material="color:#505050"
                shadow="cast: true; receive: true">
      </a-entity>

      <a-entity id="TrimB1" position="-7 0 -6.5" rotation="0 0 0" scale="1 1 1"
                geometry="primitive:box; width:0.5; height:0.5; depth:12;" material="color:black"
                shadow="cast: true; receive: true">
      </a-entity>

      <a-entity id="TrimB2" position="-7 0 5" rotation="0 0 0" scale="1 1 1"
                geometry="primitive:box; width:0.5; height:0.5; depth:5;" material="color:black"
                shadow="cast: true; receive: true">
      </a-entity>
    </a-entity>

    <!-- WALL C -->
    <a-entity id='wall-c'>
      <a-entity id="WallC1" position="-4.5 3.5 -12.5" rotation="0 90 0" scale="1 1 1"
                geometry="primitive:box; width:0.5; height:8; depth:5.5;" material="color:#505050"
                shadow="cast: true; receive: true">
      </a-entity>

      <a-entity id="WallC2" position="4.5 3.5 -12.5" rotation="0 90 0" scale="1 1 1"
                geometry="primitive:box; width:0.5; height:8; depth:5.5;" material="color:#505050"
                shadow="cast: true; receive: true">
      </a-entity>

      <a-entity id="WallC3" position="0 5.75 -12.5" rotation="0 90 0" scale="1 1 1"
                geometry="primitive:box; width:0.5; height:3.5; depth:3.5;" material="color:#505050"
                shadow="cast: true; receive: true">
      </a-entity>

      <a-entity id="TrimC1" position="-4.5 0 -12" rotation="0 90 0" scale="1 1 1"
                geometry="primitive:box; width:0.5; height:.5; depth:5.5;" material="color:black"
                shadow="cast: true; receive: true">
      </a-entity>

      <a-entity id="TrimC2" position="4.5 0 -12" rotation="0 90 0" scale="1 1 1"
                geometry="primitive:box; width:0.5; height:.5; depth:5.5;" material="color:black"
                shadow="cast: true; receive: true">
      </a-entity>
    </a-entity>

    <!-- WALL D -->
    <a-entity id='wall-d'>
      <a-entity id="WallD1" position="-4.5 3.5 7.5" rotation="0 90 0" scale="1 1 1"
                geometry="primitive:box; width:0.5; height:8; depth:5.5;" material="color:#505050"
                shadow="cast: true; receive: true">
      </a-entity>

      <a-entity id="WallD2" position="4.5 3.5 7.5" rotation="0 90 0" scale="1 1 1"
                geometry="primitive:box; width:0.5; height:8; depth:5.5;" material="color:#505050"
                shadow="cast: true; receive: true">
      </a-entity>

      <a-entity id="WallD3" position="0 5.75 7.5" rotation="0 90 0" scale="1 1 1"
                geometry="primitive:box; width:0.5; height:3.5; depth:3.5;" material="color:#505050"
                shadow="cast: true; receive: true">
      </a-entity>

      <a-entity id="TrimD1" position="-4.5 0 7" rotation="0 90 0" scale="1 1 1"
                geometry="primitive:box; width:0.5; height:.5; depth:5.5;" material="color:black"
                shadow="cast: true; receive: true">
      </a-entity>

      <a-entity id="TrimD2" position="4.5 0 7" rotation="0 90 0" scale="1 1 1"
                geometry="primitive:box; width:0.5; height:.5; depth:5.5;" material="color:black"
                shadow="cast: true; receive: true">
      </a-entity>
    </a-entity>

    <!-- PILLARS -->
    <a-entity id='pillars'>
      <a-entity id="Pillar1" position="-7 3.5 -12" rotation="0 90 0" scale="1 1 1"
                geometry="primitive:cylinder; height:8; radius:1.5;" material="color:black" shadow="cast:false; receive:true;"
                shadow="cast: true; receive: true">
      </a-entity>

      <a-entity id="Pillar2" position="7 3.5 -12" rotation="0 90 0" scale="1 1 1"
                geometry="primitive:cylinder; height:8; radius:1.5;" material="color:black" shadow="cast:false; receive:true;"
                shadow="cast: true; receive: true">
      </a-entity>

      <a-entity id="Pillar3" position="-7 3.5 7" rotation="0 90 0" scale="1 1 1"
                geometry="primitive:cylinder; height:8; radius:1.5;" material="color:black" shadow="cast:false; receive:true;"
                shadow="cast: true; receive: true">
      </a-entity>

      <a-entity id="Pillar4" position="7 3.5 7" rotation="0 90 0" scale="1 1 1"
                geometry="primitive:cylinder; height:8; radius:1.5;" material="color:black" shadow="cast:false; receive:true;"
                shadow="cast: true; receive: true">
      </a-entity>
    </a-entity>

    <!-- SHADOW BOXES 1 -->
    <a-entity id='shadow-boxes-1'>
      <a-entity id="sb1-back" position="8.5 2.75 1" rotation="0 -90 0" scale="1 1 1"
                geometry="primitive:plane; width:4; height:9;" material="color:black"
                shadow="cast: false; receive: false">
      </a-entity>

      <a-entity id="sb1-floor" position="8.25 0 1" rotation="-90 0 0" scale="1 1 1"
                geometry="primitive:plane; width:4; height:9;" material="color:#CCCCCC"
                shadow="cast: false; receive: false">
      </a-entity>

      <a-entity id="sb1-left" position="8.25 2.75 -0.75" rotation="0 0 0" scale="1 1 1"
                geometry="primitive:plane; width:1; height:9;" material="color:black"
                shadow="cast: false; receive: false">
      </a-entity>

      <a-entity id="sb1-right" position="-8.25 2.75 2.75" rotation="0 180" scale="1 1 1"
                geometry="primitive:plane; width:1; height:9;" material="color:black"
                shadow="cast: false; receive: false">
      </a-entity>
    </a-entity>

    <!-- SHADOW BOXES 2 -->
    <a-entity id='shadow-boxes-2'>
      <a-entity id="sb2-back" position="-8.5 2.75 1" rotation="0 90 0" scale="1 1 1"
                geometry="primitive:plane; width:4; height:9;" material="color:black"
                shadow="cast: false; receive: false">
      </a-entity>

      <a-entity id="sb2-floor" position="-8.25 0 1" rotation="-90 0 0" scale="1 1 1"
                geometry="primitive:plane; width:4; height:9;" material="color:#CCCCCC"
                shadow="cast: false; receive: false">
      </a-entity>

      <a-entity id="sb2-left" position="-8.25 2.75 -0.75" rotation="0 0 0" scale="1 1 1"
                geometry="primitive:plane; width:1; height:9;" material="color:black"
                shadow="cast: false; receive: false">
      </a-entity>

      <a-entity id="sb2-right" position="8.25 2.75 2.75" rotation="0 180" scale="1 1 1"
                geometry="primitive:plane; width:1; height:9;" material="color:black"
                shadow="cast: false; receive: false">
      </a-entity>
    </a-entity>

    <!-- SHADOW BOXES 3 -->
    <a-entity id='shadow-boxes-3'>
      <a-entity id="sb3-back" position="0 2.75 8.5" rotation="0 180 0" scale="1 1 1"
                geometry="primitive:plane; width:4; height:9;" material="color:black"
                shadow="cast: false; receive: false">
      </a-entity>

      <a-entity id="sb3-floor" position="0 0 9.5" rotation="-90 90 0" scale="1 1 1"
                geometry="primitive:plane; width:4; height:9;" material="color:#CCCCCC"
                shadow="cast: false; receive: false">
      </a-entity>

      <a-entity id="sb3-left" position="2 2.75 8.25" rotation="0 -90 0" scale="1 1 1"
                geometry="primitive:plane; width:1; height:9;" material="color:black"
                shadow="cast: false; receive: false">
      </a-entity>

      <a-entity id="sb3-right" position="-2 2.75 8.25" rotation="0 90" scale="1 1 1"
                geometry="primitive:plane; width:1; height:9;" material="color:black"
                shadow="cast: false; receive: false">
      </a-entity>
    </a-entity>

    <!-- SHADOW BOXES 4 -->
    <a-entity id='shadow-boxes-4'>
      <a-entity id="sb4-back" position="0 2.75 -13.5" rotation="0 0 0" scale="1 1 1"
                geometry="primitive:plane; width:4; height:9;" material="color:black"
                shadow="cast: false; receive: false">
      </a-entity>

      <a-entity id="sb4-floor" position="0 0 -12.5" rotation="-90 90 0" scale="1 1 1"
                geometry="primitive:plane; width:4; height:9;" material="color:#CCCCCC"
                shadow="cast: false; receive: false">
      </a-entity>

      <a-entity id="sb4-left" position="2 2.75 -13.25" rotation="0 -90 0" scale="1 1 1"
                geometry="primitive:plane; width:1; height:9;" material="color:black"
                shadow="cast: false; receive: false">
      </a-entity>

      <a-entity id="sb4-right" position="-2 2.75 -13.25" rotation="0 90" scale="1 1 1"
                geometry="primitive:plane; width:1; height:9;" material="color:black"
                shadow="cast: false; receive: false">
      </a-entity>
    </a-entity>

  </a-scene>
</body>
</html>
