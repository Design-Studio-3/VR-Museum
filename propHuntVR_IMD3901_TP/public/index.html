<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Virtual Museum</title>
  <meta name="description" content="The bois' museum">

  <!-- CSS stylesheets -->
  <link rel="stylesheet" href="css/user-gesture.css">

  <!-- Library imports -->
  <script src="/js/libraries/aframe.min.js"></script>
  <script src="/js/libraries/aframe-environment-component.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>

  <!-- Physics -->
  <script src="https://cdn.jsdelivr.net/gh/n5ro/aframe-physics-system@v4.0.1/dist/aframe-physics-system.min.js"></script>

  <!-- Environment engine-->
  <script src="https://unpkg.com/aframe-environment-component@1.2.0/dist/aframe-environment-component.min.js"></script>

  <!-- Custom components imports -->
  <script src="/js/player.js"></script>
  <script src="/js/player-controller.js"></script>
  <script src="/js/other-player.js"></script>
  <script src="/js/hmd.js"></script>
</head>

<script>
  const socket = io({transports: ['websocket'], upgrade: false});

  // emitted when this player connects
  socket.on('connect', () => {
  });

  // emitted to update the position of all other players
  socket.on('updatePlayers', (data) => {
    // get the players-controller
    var playersController = document.querySelector('[players-controller]');

    // loop through each player in the data list
    for (var i = 0; i < data.players.length; i++) {
      // update the current player from the list
      playersController.emit('updatePlayer', {player: data.players[i]});
    }
  });

  // emitted at the beginning to get all currently connected players
  socket.on('spawnInitialPlayers', (data) => {
    // get the players-controller
    var playersController = document.querySelector('[players-controller]');

    // loop through each player in the data list
    for (var i = 0; i < data.players.length; i++) {
      // make sure the current player is not ourself
      if (data.players[i].id != socket.id) {
        // add the connected player from the list
        playersController.emit('addPlayer', {player: data.players[i]});
      }
    }
  });

  // emitted to add a new player on the client side
  socket.on('playerJoined', (data) => {
    document.querySelector('[players-controller]').emit(
      'addPlayer', {player: data.player});
  });
</script>

<body>
  <a-scene physics="debug: true">
    <!-- <div id="ui"></div> -->
    <div id="text"></div>

      <a-assets timeout="10000">
        <a-asset-item id="hmd-gltf" src="assets/scene.gltf"></a-asset-item>

        <!-- Environment -->
        <a-asset-item id="env-floor" src="assets/environment/Environment_blockout_floor.obj"></a-asset-item>
        <a-asset-item id="env-walls" src="assets/environment/Environment_blockout_walls.obj"></a-asset-item>
        <a-asset-item id="env-mouldings-pillar1" src="assets/environment/Environment_moulding_pillar1.obj"></a-asset-item>
        <a-asset-item id="env-mouldings-pillar2" src="assets/environment/Environment_moulding_pillar2.obj"></a-asset-item>
        <a-asset-item id="env-mouldings-exterior-walls" src="assets/environment/Environment_moulding_exteriorWalls.obj"></a-asset-item>
        <a-asset-item id="env-mouldings-interior-walls" src="assets/environment/Environment_moulding_interiorWalls.obj"></a-asset-item>
      </a-assets>

    <!-- LIGHTS -->
    <a-entity id="lights">
      <a-entity light="type:point; intensity:1.0; castShadow:false;"
                position="0 5 5"
                rotation="-45 0 0">
      </a-entity>

      <a-entity light="type:spot; intensity:1.0; castShadow:true; angle:25"
                position="0 5 -4"
                rotation="-90 0 0">
      </a-entity>
    </a-entity>

    <a-entity id="camera"
              player camera wasd-controls
              look-controls="pointerLockEnabled: true" position="0 2 0">
      <a-entity class="geo"></a-entity>
      <a-entity cursor="rayOrigin:mouse;" raycaster="far:20; interval:200; objects: .interactive"></a-entity>
    </a-entity>

    <!-- PLAYERS CONTROLLER (for viewing other players) -->
    <a-entity players-controller></a-entity>

    <!-- Virtual reality headset -->
    <a-entity hmd
              gltf-model="#hmd-gltf"
              class="interactive"
              position="0 1.65 -3.9"
              scale="0.06 0.06 0.06"
              rotation="0 25 0"
              shadow="cast: true; receive: true">
    </a-entity>

    <!-- PEDESTAL -->
    <a-entity id="pedestal">
      <a-entity id="pedestalPillar" position="0 0.5 -4" rotation="0 0 0" scale="1 1 1"
                geometry="primitive:cylinder; height:2; radius: 0.5;" material="color:red"
                shadow="cast: true; receive: true">
      </a-entity>

      <a-dodecahedron position="0 -1.4 -4"
        rotation="-32.5 1.5 0"
        material="color:black"
        radius="2"
        shadow="cast:true; receive:true;">
      </a-dodecahedron>
    </a-entity>

    <!-- Environment -->
    <a-obj-model static-body src="#env-floor" mtl="#env-floor"></a-obj-model>
    <a-obj-model static-body='shape: convex;' src="#env-mouldings-pillar1" mtl="#env-mouldings-pillar1"></a-obj-model>
    <a-obj-model static-body='shape: convex;' src="#env-mouldings-pillar2" mtl="#env-mouldings-pillar2"></a-obj-model>
    <a-obj-model static-body='shape: convex;' src="#env-walls" mtl="#env-walls"></a-obj-model>
    <a-obj-model static-body='shape: convex;' src="#env-mouldings" mtl="#env-mouldings"></a-obj-model>
    <a-obj-model static-body='shape: convex;' src="#env-mouldings-exterior-walls" mtl="#env-mouldings-exterior-walls"></a-obj-model>
    <a-obj-model static-body='shape: convex;' src="#env-mouldings-interior-walls" mtl="#env-mouldings-interior-walls"></a-obj-model>

    <a-entity environment='preset:starry;'></a-entity>

  </a-scene>
</body>
</html>
